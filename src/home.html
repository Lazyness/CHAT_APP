<!DOCTYPE html>
<html lang="en">

<head>
    <title>Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Uchen&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300&display=swap" rel="stylesheet">
</head>

<body>
    <header class="header">
        <img class="logo" src="images/logo.png" alt="logo">
        <div class="div__edit__time">
            <div class="info">
                <div id="div__time">
                </div>
                <div class="div__edit">
                    <a href="#"><strong>Edit personal info</strong></a>
                    <a href="#"><strong>Private messages</strong></a>
                </div>
            </div>
            <div class="div__btn">
                <a href="index.html" class="btn__header" style="margin-bottom: 10%;">Login</a>
                <a href="registration.html" class="btn__header" style="margin-bottom: 10%;">Registration</a>
                <a href="index.html" class="btn__header" onclick="isClickExit()">Exit</a>
            </div>
        </div>
        </div>
    </header>
    <div class="div__main">
        <div class="div__scroll_class">
            <div id="div__users__chat__online">
                <div id="div__users__chat">
                </div>
            </div>
        </div>
        <div class="div__chat">
            <div class="div__tabs">
                <p class="p__tabs" style="background: rgba(0, 174, 197, 0.2);">Main chat</p>
                <!-- <p class="p__tabs" style="background: rgba(50, 50, 50, 0.6);">Chat with Alison</p> -->
            </div>
            <div class="div__chat_m">
                <div class="users">
                    <div id="div__scroll__message"></div>
                </div>
            </div>
            <input class="div__enter__message" type="text" id="messages" name="messages"
                placeholder="Write a message...">
            <div class="buttons">
                <button class="button__message">B</button>
                <button class="button__message">I</button>
                <button class="button__message">U</button>
                <button class="button__message" style="margin-left: 2%;">Link</button>
                <button class="button__message"
                    style="float: right; margin-top: 1%;width: 15%; text-transform: uppercase;"
                    onclick="isSendMess()">Send message</button>
            </div>
        </div>
    </div>
    <footer class="footer">
        <h4>Widget for displaying information about the entered
            message</h4>
        <div class="div__f__p">
            <p>31 characters entered;</p>
            <p>25 letters endered;</p>
            <p>4 whitespace characters entered;</p>
            <p>2 punctuation marks entered.</p>
            <p><strong>Have a nice day ;D</strong></p>
    </footer>
    <script>
        function get_cookie(cookie_name) {
            let results = document.cookie.match('(^|;) ?' + cookie_name + '=([^;]*)(;|$)');
            if (results)
                return (unescape(results[2]));
            else
                return null;
        }
        // alert(document.cookie);
        let id = get_cookie("id_user");
        let user = get_cookie("user");
        let dateStartSession = new Date(get_cookie("date"));
        // function statusOk() {
        //     if (user != undefined && user != null) {

        //     }
        // }

        function usersInChat(method, url) {
            let xhr = new XMLHttpRequest();

            xhr.open(method, url);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.responseType = 'json';
            let flagCheck = false;
            xhr.onload = () => {
                if (xhr.status >= 400) {
                    alert("status>400")
                } else {
                    let countOnline = 0, allUsers = 0;
                    for (let i = 0; i < xhr.response.length; i++) {
                       let idAvatar = xhr.response[i].avatarId;
                        if (user == null && id == null) {
                            document.cookie = "id_user=;max-age=-1";
                            document.location.href = "index.html";
                        }
                        if (xhr.response[i].username == user && xhr.response[i].user_id == id) {
                            flagCheck = true;
                        }
                        if (xhr.response[i].status == "active") {
                            let divRed = document.createElement('div');
                            divRed.innerHTML = '.';
                            divRed.style.width = '10%';
                            divRed.style.height = '5%';
                            divRed.style.border = '2px solid #fff';
                            divRed.style.borderRadius = '50%';
                            divRed.style.background = 'green';
                            divRed.style.color = 'green';
                            divRed.style.display = 'inline-block';
                            div__users__chat.append(divRed);
                            
                            // отображаем аватар пользователя
                            // let img = document.createElement('img');
                            // img.src = `D://Andersen/CHAT_APP/src/images/01.svg`;

                            // div__users__chat.append(img);
                            countOnline++;
                        } else {
                            let divRed = document.createElement('div');
                            divRed.innerHTML = '.';
                            divRed.style.width = '10%';
                            // divRed.style.height = '5%';
                            divRed.style.border = '2px solid #000';
                            divRed.style.borderRadius = '50%';
                            divRed.style.background = 'red';
                            divRed.style.color = 'red';
                            divRed.style.display = 'inline-block';
                            div__users__chat.append(divRed);
                        }
                        let pLast = document.createElement('p');
                        pLast.innerHTML = xhr.response[i].username;
                        pLast.style.display = 'inline-block';
                        pLast.style.marginLeft = '10%';
                        pLast.style.fontSize = '18px';
                        pLast.style.fontFamily = 'Uchen';
                        div__users__chat.append(pLast);

                        let tempBlock = document.createElement('div');
                        tempBlock.innerHTML = '';
                        tempBlock.style.marginBottom = '2%';
                        div__users__chat.append(tempBlock);
                        allUsers++;

                        if (xhr.response[i].user_id == id) {
                            let pLast = document.createElement('p');
                            pLast.innerHTML = xhr.response[i].username;
                            pLast.style.display = 'inline-block';
                            pLast.style.fontFamily = 'Uchen';
                            div__time.prepend(pLast);
                            div__time.prepend("User: ");
                        }
                    }
                    if (!flagCheck) {
                        document.cookie = "id_user=;max-age=-1";
                        document.location.href = "index.html";
                    }
                    let pOnline = document.createElement('p');
                    pOnline.style.display = 'flex';
                    pOnline.style.justifyContent = 'space-around';
                    pOnline.style.fontSize = '20px';
                    pOnline.innerHTML = 'Online: ' + countOnline;
                    div__users__chat__online.prepend(pOnline);

                    let pAllUsers = document.createElement('p');
                    pAllUsers.style.display = 'flex';
                    pAllUsers.style.justifyContent = 'space-around';
                    pAllUsers.style.fontSize = '26px';
                    pAllUsers.innerHTML = 'All users: ' + allUsers;
                    div__users__chat__online.prepend(pAllUsers);
                }
            }
            xhr.onerror = () => alert("Error!");

            xhr.send();
        }

        function isShowCurrentDate() {
            let date = new Date();

            dateTime = addNull(date.getHours()) + ":" + addNull(date.getMinutes());
            // Your local time is:
            let divTime = document.createElement('p');
            divTime.innerHTML = "Your local time is: " + dateTime;

            div__time.append(divTime);


            let hour = date.getHours() - dateStartSession.getHours();
            let minutes = date.getMinutes() - dateStartSession.getMinutes();
            let days = date.getDay() - date.getDay();
            let diff = days + "d " + hour + "h " + minutes + "m";

            let divDiff = document.createElement('p');
            divDiff.innerHTML = "You are online for: " + diff;

            div__time.prepend(divDiff);
            // alert(diff);

        }

        function isSendMess() {
            const userName = user;

            const messUser = document.getElementById('messages').value;
            // alert(messUser);

            // текущая дата
            let date = new Date().toISOString();
            // alert(date);

            // dateTime = date.getFullYear() + "." + addNull(date.getMonth()) + "." + addNull(date.getDate()) + " " + addNull(date.getHours()) + ":" + addNull(date.getMinutes());

            let xhr = new XMLHttpRequest();

            xhr.open("POST", "https://studentschat.herokuapp.com/messages");
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.send(JSON.stringify({ datetime: date, message: messUser, username: userName }));
            alert(userName + " you send message!");
            xhr.onload = () => alert(xhr.response);

            document.location.href = "home.html";
        }

        function addNull(numb) {
            if (numb < 10) {
                return '0' + numb;
            } else
                return numb;
        }

        function isClickExit() {
            let xhr = new XMLHttpRequest();

            xhr.open("POST", "https://studentschat.herokuapp.com/users/logout");
            xhr.setRequestHeader('Content-Type', 'application/json');
            alert(user);
            xhr.send(JSON.stringify({ username: user }));

            xhr.onload = () => alert(xhr.response);

            //стираем куки
            document.cookie = "id_user=;max-age=-1";
        }

        function make_safe(input) {
            return input.replace("&", "&amp;").replace(/(<?)([^<>]*)(>?)/g, (a, b, c, d) => {
                if ((b + c + d).toLowerCase() === "<br>") return "<br>";

                if (b === "<") b = "&lt;";
                if (b === ">") b = "&gt;";

                if (d === "<") d = "&lt;";
                if (d === ">") d = "&gt;";

                return b + c + d;
            }).replace(/\r?\n/g, "<br>");
        }

        function isShowMessage(method, url) {
            let xhr = new XMLHttpRequest();

            xhr.open(method, url);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.responseType = 'json';
            xhr.onload = () => {
                if (xhr.status >= 400) {
                    alert("status>400")
                } else {
                    for (let i = 0; i < xhr.response.length; i++) {
                        date = new Date(xhr.response[i].datetime);
                        year = date.getFullYear();
                        month = date.getMonth() + 1;
                        dt = date.getDate();
                        hour = date.getHours();
                        min = date.getMinutes();
                        if (xhr.response[i].username == user) {

                            let divMessageMe = document.createElement('code');
                            divMessageMe.innerHTML = make_safe(xhr.response[i].message);
                            divMessageMe.style.border = '1px solid #fff';
                            divMessageMe.style.display = 'table';
                            divMessageMe.style.marginLeft = 'auto';
                            divMessageMe.style.marginBottom = '2%';
                            divMessageMe.style.padding = '2%';
                            divMessageMe.style.wordBreak = "break-all";
                            divMessageMe.style.borderRadius = '15px 15px 0 15px';
                            divMessageMe.style.background = 'rgba(0, 0, 0, 0.4)';

                            div__scroll__message.append(divMessageMe);

                            let divMessageName = document.createElement('div');
                            divMessageName.innerHTML = xhr.response[i].username;
                            divMessageName.style.fontSize = '20px';
                            // divMessageName.style.fontFamily = 'Uchen';
                            divMessageName.style.color = "darkorange";
                            divMessageName.style.fontWeight = 'bold';
                            // divMessageName.style.fontStyle = 'italic';
                            divMessageMe.prepend(divMessageName);

                            let divMessageDate = document.createElement('div');
                            divMessageDate.innerHTML = addNull(dt) + "." + addNull(month) + "." + year + " " + addNull(hour) + ":" + addNull(min);
                            divMessageDate.style.textAlign = "end";
                            divMessageDate.style.fontSize = '12px';
                            divMessageMe.append(divMessageDate);

                        } else {
                            let divMessageAll = document.createElement('code');
                            divMessageAll.innerHTML = make_safe(xhr.response[i].message);
                            divMessageAll.style.border = '1px solid #fff';
                            divMessageAll.style.display = 'table';
                            divMessageAll.style.marginBottom = '2%';
                            divMessageAll.style.borderRadius = '15px 15px 15px 0';
                            divMessageAll.style.padding = '2%';
                            divMessageAll.style.wordBreak = "break-all";
                            divMessageAll.style.background = 'rgba(214, 96, 0, 0.4)';

                            div__scroll__message.append(divMessageAll);

                            let divMessageName = document.createElement('div');
                            divMessageName.innerHTML = xhr.response[i].username;
                            divMessageName.style.fontSize = '20px';
                            // divMessageName.style.fontFamily = 'Uchen';
                            divMessageName.style.fontWeight = 'bold';
                            // divMessageName.style.fontStyle = 'italic';
                            divMessageName.style.color = "rgba(0, 174, 197, 1)";
                            divMessageAll.prepend(divMessageName);

                            let divMessageDate = document.createElement('div');
                            divMessageDate.innerHTML = addNull(dt) + "." + addNull(month) + "." + year + " " + addNull(hour) + ":" + addNull(min);
                            divMessageDate.style.textAlign = "end";
                            divMessageDate.style.fontSize = '12px';
                            divMessageAll.append(divMessageDate);
                        }
                    }
                }
            }
            xhr.onerror = () => alert("Error!");

            xhr.send();
        }

        function BoldText() {

        }

        usersInChat("GET", "https://studentschat.herokuapp.com/users");
        isShowMessage("GET", "https://studentschat.herokuapp.com/messages");
        isShowCurrentDate();


        // statusOk();
    </script>
</body>

</html>